name: Semantic Versioning

on:
  push:
    branches:
      - main
      - dev

jobs:
  versioning:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - run: git fetch --tags

      # Última tag
      - name: Get latest tag
        id: tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$TAG" >> $GITHUB_ENV

      # Commits desde última versão
      - name: Collect commits
        id: commits
        run: |
          RANGE="${{ env.latest_tag }}..HEAD"
          git log --pretty="%H|%s" $RANGE > commits.txt || true

      # Determinar bump + commit correto
      - name: Analyze commits (cumulative)
        id: analyze
        run: |
          PATCH_COUNT=0
          MINOR_COUNT=0
          MAJOR_COUNT=0

          while IFS='|' read -r SHA MSG; do
            if [[ "$MSG" == *"BREAKING CHANGE"* ]]; then
              MAJOR_COUNT=$((MAJOR_COUNT+1))
            elif [[ "$MSG" =~ ^feat(\(.+\))?: ]]; then
              MINOR_COUNT=$((MINOR_COUNT+1))
            elif [[ "$MSG" =~ ^(fix|docs|style|test|ci)(\(.+\))?: ]]; then
              PATCH_COUNT=$((PATCH_COUNT+1))
            fi
          done < commits.txt

          echo "patch_count=$PATCH_COUNT" >> $GITHUB_ENV
          echo "minor_count=$MINOR_COUNT" >> $GITHUB_ENV
          echo "major_count=$MAJOR_COUNT" >> $GITHUB_ENV

          if [ "$PATCH_COUNT" -eq 0 ] && [ "$MINOR_COUNT" -eq 0 ] && [ "$MAJOR_COUNT" -eq 0 ]; then
            echo "bump=none" >> $GITHUB_ENV
          else
            echo "bump=yes" >> $GITHUB_ENV
          fi

      # Parar tudo se não houver bump
      - name: Stop if no version change
        if: env.bump == 'none'
        run: echo "No versionable commits — stopping."

      # Calcular nova versão
      - name: Calculate new version
        if: env.bump == 'yes'
        run: |
          VERSION=${{ env.latest_tag }}
          VERSION=${VERSION#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          if [ "${{ env.major_count }}" -gt 0 ]; then
            MAJOR=$((MAJOR + ${{ env.major_count }}))
            MINOR=0
            PATCH=0
          else
            MINOR=$((MINOR + ${{ env.minor_count }}))
            PATCH=$((PATCH + ${{ env.patch_count }}))
          fi

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_ENV


      # Configurar git
      - name: Git config
        if: env.bump != 'none'
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

      # TAG NO COMMIT CERTO
      - name: Tag correct commit
        if: env.bump != 'none'
        run: |
          git tag ${{ env.new_version }} ${{ env.target_sha }}
          git push origin ${{ env.new_version }}

      # package.json
      - name: Update package.json
        if: env.bump != 'none'
        run: |
          VERSION=${{ env.new_version }}
          VERSION=${VERSION#v}

          # Procurar todos os package.json
          FILES=$(find . -name package.json)

          if [ -z "$FILES" ]; then
            echo "No package.json found, skipping."
            exit 0
          fi

          sudo apt-get update && sudo apt-get install -y jq

          for FILE in $FILES; do
            echo "Updating $FILE version to $VERSION"
            jq ".version=\"$VERSION\"" "$FILE" > tmp.json && mv tmp.json "$FILE"
            git add "$FILE"

            # Atualiza package-lock.json correspondente
            DIR=$(dirname "$FILE")
            cd "$DIR"
            npm install --package-lock-only
            git add package-lock.json
            cd - > /dev/null
          done

      # CHANGELOG
      - name: Update changelog
        if: env.bump != 'none'
        run: |
          DATE=$(date +'%Y-%m-%d')
          VERSION=${{ env.new_version }}

          touch CHANGELOG.md RELEASE_NOTES.md
          LOG=$(git log --pretty=format:"* %s" ${{ env.latest_tag }}..HEAD)

          echo "## $VERSION - $DATE" > tmp1.md
          echo "$LOG" >> tmp1.md
          cat CHANGELOG.md >> tmp1.md
          mv tmp1.md CHANGELOG.md

          echo "## $VERSION - $DATE" > tmp2.md
          echo "$LOG" >> tmp2.md
          cat RELEASE_NOTES.md >> tmp2.md
          mv tmp2.md RELEASE_NOTES.md

          git add CHANGELOG.md RELEASE_NOTES.md

      # Commit automático
      - name: Commit release files
        if: env.bump != 'none'
        run: |
          git diff --cached --quiet || git commit -m "chore(release): ${{ env.new_version }}"
          git push origin HEAD
